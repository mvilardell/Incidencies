<!DOCTYPE html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<!--ESTILS DE BOOTSTRAP -->
	<link href="../css/bootstrap.min.css" rel="stylesheet"/>
	<link type="text/css" href="../css/estil.css" rel="stylesheet"/>
	<script type="text/javascript" src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
	<!-- Carregar GoogleMaps Api V3-->
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
	<script src="http://maps.google.com/maps/api/js?sensor=false&libraries=geometry" type="text/javascript"></script>
	<script type="text/javascript" src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
	<!--ARXIUS JAVASCRIPT DE BOOTSTRAP -->
	<script type="text/javascript" src="../js/bootstrap.min.js"></script>
	<script type="text/javascript" src="../js/md5.js"></script>
	<script>
	$(function(){
	
		//VARIABLES GENERALS
		var mapa = null;
		var f_IdIncidencia = localStorage.getItem("IdIncidencia");
	
		$(document).on("ready", function(){
			var formulari = $("#formulari");
	
			var defaultPos = new google.maps.LatLng(19.289168,-99.653440);
					
			if (navigator.geolocation) {
				function exito(pos) {
					MuestraMapa(new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
				}
				function falla(error) {
					//si falla mostrar mpara en posicion por defecto
					alert('Error en servicio Geolocalizador');
					//MuestraMapa(defaultPos); 
				}
				
				//maximumAge- Guarda la posicion por x minutos 
				//enableHighAccuracy: Se tratan de obtener los mejores resultados posible del GPS
				//timeout: el tiempo maximo que se espera para obtener la posicion en este caso 5 segundos
				var options = {maximumAge: 30000, enableHighAccuracy:true, timeout: 5000};
				navigator.geolocation.getCurrentPosition(exito, falla, options );
			}//FIN IF
			else {
				//MuestraMapa(defaultPos);  // No soporta geolocalizacion y dibuja el mapa en posicion Default
			}	
			 
			//FUNCION DIBUJAR MAPa
			function MuestraMapa(latlng) {
				var config = {
				zoom: 16,
				center: latlng,
				disableDefaultUI: true,
				mapTypeId: google.maps.MapTypeId.ROADMAP};
				
				//COORDENADES
				var coordenades = String(latlng);//event.latLng.toString();
				
				//REMOURE PARENTESIS
				coordenades = coordenades.replace("(","");
				coordenades = coordenades.replace(")","");
				//COORDENADES PER SEPARAT
				var llista = coordenades.split(",");
				
				
				//PASSAR LES COORDENADES AL FORMULARI
				formulari.find("input[name='LongX']").val(llista[1]);
				formulari.find("input[name='LatY']").val(llista[0]);
				
			}
			
			formulari.find("input[name='IdIncidencia']").val(f_IdIncidencia);
			
			$.ajax({type: "POST",
				url:"http://www.grupllobet.com/apptest/Incidencies/DadesIncidencia.php",
				data:({ID: f_IdIncidencia}),
				cache: false,
				dataType: "text",
				success: function(data){
					var dades_incidencia = data.split("#");
					
					formulari.find("input[name='UsuariAlta']").val(dades_incidencia[0]);
					formulari.find("input[name='Descripcion']").val(dades_incidencia[1]);
					formulari.find("input[name='Fecha']").val(dades_incidencia[2]);
					formulari.find("input[name='Hora']").val(dades_incidencia[3]);
					$("#Solucion").focus();
				}
				
			});

			
			$("#ferregistre").click(function(){				
				
				var fSolucion = $("#Solucion").val();

				if(fSolucion == ""){
					alert('Solució necessari');
					$("#Solucion").focus();
				}else{

					$("#Solucion").val("");
					$.ajax({type: "POST",
						url:"http://www.grupllobet.com/apptest/Incidencies/update.php",
						data:({ID: f_IdIncidencia, Solucion: fSolucion}),
						cache: false,
						dataType: "text",
						success: Update
					});
					function Update(data){
						alert(data);
						location.href="llistat_incidencies.html";
					}
					
				}
			});
		});
	});
	</script>
</head>
<body style="background: gray">
	<div id="formulari">
		<h1>REGISTRE</h1>
		<form method="POST">
			<table>
			<tr>
				<td><label for="IdIncidencia">ID:</label></td>
				<td><input type="text" disabled="disabled" name="IdIncidencia" id="IdIncidencia" value=""  /></td>
			</tr>
			<tr>
				<td><label for="UsuariAlta">Usuari alta:</label></td>
				<td><input type="text" disabled="disabled" name="UsuariAlta" id="UsuariAlta" value=""  /></td>
			</tr>
			<tr>
				<td><label for="Descripcion">Descripció:</label></td>
				<td><input type="text" disabled="disabled" name="Descripcion" id="Descripcion" value=""  /></td>
			</tr>
			<tr>
				<td><label for="Fecha">Data obertura:</label></td>
				<td><input type="text" disabled="disabled" name="Fecha" id="Fecha" value=""  /></td>
			</tr>
			<tr>
				<td><label for="Hora">Hora obertura:</label></td>
				<td><input type="text" disabled="disabled" name="Hora" id="Hora" value=""  /></td>
			</tr>
			<tr>
				<td><label>Solució:</label></td> 
				<td><input type="text" name="Solucion" id="Solucion" value=""></td>
			</tr>
			<tr>
				<td><label for="LatY">Latitud:</label></td>
				<td><input type="text" disabled="disabled" name="LatY" id="LatY" value=""  /></td>
			</tr>
			<tr>
				<td><label for="LongX">Longitud:</label></td>
				<td><input type="text" disabled="disabled" name="LongX" id="LongX" value="" /></td>
			</tr>
			<tr>
				<td><button type="button" onclick="window.location.href='llistat_incidencies.html'">Tornar</button></td>
				<td><button type="button" id="ferregistre">Finalitzar incidència</button></td>
			</tr>
			</table>
		</form>	
	</div>
</body>
</html>
